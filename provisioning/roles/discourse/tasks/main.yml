---
- name: Ensure latest git is installed
  apt: pkg=git state=latest

- name: Ensure that /var/discourse exists
  file: path=/var/discourse owner=deploy group=deploy state=directory

- name: Get the official discourse docker image
  command: git clone https://github.com/discourse/discourse_docker.git /var/discourse creates=/var/discourse/README.md

- name: Copy over app configuration
  template: src=app.yml.j2 dest=/var/discourse/containers/app.yml owner=deploy group=deploy mode=0640

- name: Stop unnamed discourse containers from failed attempts
  shell: |
    # Stop any unnamed containers (not 'app')
    docker ps -a | grep 'discourse/base' | grep -v ' app ' | awk '{print $1}' | xargs -r docker stop
  ignore_errors: yes

- name: Remove up unnamed discourse containers from failed attempts
  shell: |
     # Remove any unnamed containers (not 'app')
     docker ps -a | grep 'discourse/base' | grep -v ' app ' | awk '{print $1}' | xargs -r docker rm
  ignore_errors: yes

- name: Check available memory
  shell: free -m | grep Mem | awk '{print $2}'
  register: memory_check
  failed_when: memory_check.stdout|int < 2048

- name: Check if PostgreSQL data directory is initialized
  stat:
    path: /var/discourse/shared/standalone/postgres_data/PG_VERSION
  register: pg_initialized

- name: Remove postgres_data directory if not initialized
  file:
    path: /var/discourse/shared/standalone/postgres_data
    state: absent
  when: not pg_initialized.stat.exists

- name: Ensure shared directories exist with relaxed perms
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - /var/discourse/shared
    - /var/discourse/shared/standalone

- name: Ensure shared data directories exist with stricter perms
  file:
    path: "{{ item }}"
    state: directory
    mode: '0700'
  with_items:
    - /var/discourse/shared/standalone/postgres_data

#- name: Deliberately fail so we can run this manually
#  ansible.builtin.fail:
#    msg: "Deliberately failing so we can run: time timeout 2400 ./launcher bootstrap app && docker logs -f discourse_app_1"

- name: Bootstrap discourse app (with 1 hour timeout)
  shell: timeout 3600 ./launcher bootstrap app
  args:
    chdir: /var/discourse
    creates: /var/discourse/shared/standalone/log/rails/production.log
  ignore_errors: yes
  register: bootstrap_result
  notify: start discourse

- name: Check system resources before bootstrap
  shell: |
    echo "=== Memory ==="
    free -h
    echo "=== Disk ==="
    df -h
    echo "=== Docker Status ==="
    systemctl status docker --no-pager
  register: system_check

- name: Display system status
  debug:
    var: system_check.stdout_lines

- name: Display bootstrap result
  debug:
    msg: "Bootstrap {{ 'succeeded' if bootstrap_result.rc == 0 else 'failed or timed out' }}"

- name: Generate the nginx config for the app
  template: src=discourse.nginx dest=/etc/nginx/sites-available/{{ discourse_server_name }} owner=root group=root mode=644
  notify: restart nginx

- name: Make the nginx site active
  command: ln -s /etc/nginx/sites-available/{{ discourse_server_name }} /etc/nginx/sites-enabled/{{ discourse_server_name }} creates=/etc/nginx/sites-enabled/{{ discourse_server_name }}
  notify: restart nginx
