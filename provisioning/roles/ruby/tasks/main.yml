---
# FIXME(auxesis) install this elsewhere
- name: Ensure curl is installed
  apt: pkg=curl

- name: Add apt repository for rvm
  apt_repository: repo="ppa:rael-gc/rvm"

- name: Install rvm package
  apt: pkg=rvm

# TODO: Is it possible to extract this list of dependencies automatically from rvm?
# Or allow rvm to do the install - but that would require the deploy user to have the permissions
- name: "Ensure ruby-2.3.1 dependencies installed"
  apt: pkg={{ item }}
  with_items:
    - patch
    - gawk
    - g++
    - make
    - patch
    - libyaml-dev
    - libsqlite3-dev
    - sqlite3
    - autoconf
    - libgdbm-dev
    - libncurses5-dev
    - automake
    - libtool
    - bison
    - pkg-config
    - libffi-dev
    - libreadline6-dev
    - zlib1g-dev
    - libssl-dev
    - libgmp-dev

- name: Install ruby-2.3.1 through rvm
  shell: rvm install ruby-2.3.1 --autolibs=read-fail
  args:
    creates: /home/deploy/.rvm/rubies/ruby-2.3.1
  become: deploy
  environment:
    PATH: "{{ rvm_path }}"

- name: Test if ruby-2.3.1 is default
  shell: rvm alias show default
  become: deploy
  environment:
    PATH: "{{ rvm_path }}"
  ignore_errors: true
  changed_when: false
  register: rvm_alias_show

- name: Make ruby-2.3.1 the default
  shell: rvm alias create default ruby-2.3.1
  become: deploy
  environment:
    PATH: "{{ rvm_path }}"
  when: rvm_alias_show|failed

- name: Install bundler
  shell: rvm ruby-2.3.1; gem install bundler
  become: deploy
